<!doctype html>
<html>
<head>
    <!--进行一些网页的显示设置-->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>高德地图公交线路数据获取</title>
    <!--连接到高德服务器的一个显示方案，好像是-->
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/>
    <style type="text/css">
        html,body,#container{
            height:100%;
            width:100%;
        }
    </style>
</head>
<body>
<!--实例化高德地图-->
<div id="container"></div>
<!--公交线路搜索控件
<div class="input-card" style='width:18rem;'>
    <label style='color:grey'>公交线路查询</label>
    <div class="input-item">
        <div class="input-item-prepend"><span class="input-item-text" >线路名称</span></div>
        <input id='BusLineName' type="text" value='919' >
    </div>
    <input id="search" type="button" class="btn" value="查询" />
</div>
-->
<!--高德数据、公交线路搜索接口-->
<script type="text/javascript"
        src="https://webapi.amap.com/maps?v=1.4.15&key=37766c5c2275df68b48b60da155faed1&plugin=AMap.LineSearch"></script>
<!--获取数据-->
<script language="javascript">
    //读取公交线路名称列表，并储存为数组[name]
    var names=['1号线','10号线'];
    /*创建全局变量blr=BusLineRoutes，用于储存每条线路的信息{name:线路名称,via_stops:途径站点,path:[线路经纬度],stime:首班时间,
    etime:末班时间,basic_price:起步票价,total_price:全程票价,distance:全程距离}*/
    var blr=[];
    /*
     *获取数据，主要流程分为三个步骤，即定义了三个函数
     * 1. 首先调用公交路线查询服务(lineSearch)
     * 2. 根据返回结果解析，输出解析结果(lineSearch_Callback)
     * 3. 在地图上绘制公交线路(drawbusLine)
    */
    //实例化高德地图，即使结果显示在网页中
    var map = new AMap.Map("container", {
        resizeEnable: true,
        center: [108.911945, 34.371075],//地图中心点，初始化需要，随意设置
        zoom: 13 //地图显示的缩放级别
    });
    var linesearch;
    //公交线路查询
    function lineSearch(busLineName) {
    /*示例中有搜索控件时执行
    var busLineName = document.getElementById('BusLineName').value;*/
    if(!busLineName) return;
    //实例化公交线路查询类，只取回一条路线，可能是上行、下行线路只取一条，“!”是逻辑的“非”
    if(!linesearch){
        linesearch = new AMap.LineSearch({
            pageIndex: 1,
            city: '北京',//目标城市
            pageSize: 1,
            extensions: 'all'//获取详细信息
        });
    }
        //实例化公交线路查询类
        linesearch = new AMap.LineSearch({
            pageIndex: 1,
            city: '北京',//目标城市
            pageSize: 1,
            extensions: 'all'//获取详细信息
        });
        //搜索“buslinename”相关公交线路
        linesearch.search(busLineName, function (status, result) {
            map.clearMap()
            if (status === 'complete' && result.info === 'OK') {
                lineSearch_Callback(result);//成功查询，调用结果解析函数，如下面指定
            } else {
                <!--该公交线路名称无法查询到线路数据，存入未获取数据的数组-->
                alert(result);//alert('网页弹出的错误信息')
            }
        });
    }

    /*公交路线查询服务返回数据解析概况*/
    function lineSearch_Callback(data) {
        var lineArr = data.lineInfo;//公交线路信息的数组，[id、name、path等]
        var lineNum = data.lineInfo.length;//返回该数组的长度，即线路数目（可能公交查询结果有多条？）
        if (lineNum == 0) {
        } else {
            for (var i = 0; i < lineNum; i++) {
                //所有数据转存到全局变量中
                var bname=lineArr[i].name;
                var pathArr = lineArr[i].path;//公交线路经纬度
                var stops = lineArr[i].via_stops;//途径站
                var startPot = stops[0].location;//首发站经纬度
                var endPot = stops[stops.length - 1].location;//终点站经纬度
                var stime=lineArr[i].stime;
                var etime=lineArr[i].etime;
                var bprice=lineArr[i].basic_price;
                var tprice=lineArr[i].total_price;
                var dis=lineArr[i].distance;
                savedata(bname);
                if (i == 0) //只绘制一条线路
                    drawbusLine(startPot, endPot, pathArr);//绘制线路的函数，如下面指定
            }
        }
    }
    //绘制路线
    function drawbusLine(startPot, endPot, BusArr) {
        //绘制起点，终点
        new AMap.Marker({
            map: map,
            position: startPot, //基点位置
            icon: "https://webapi.amap.com/theme/v1.3/markers/n/start.png",
            zIndex: 10
        });
        new AMap.Marker({
            map: map,
            position: endPot, //基点位置
            icon: "https://webapi.amap.com/theme/v1.3/markers/n/end.png",
            zIndex: 10
        });
        //绘制乘车的路线
        busPolyline = new AMap.Polyline({
            map: map,
            path: BusArr,
            strokeColor: "#09f",//线颜色
            strokeOpacity: 0.8,//线透明度
            isOutline: true,
            outlineColor: 'white',
            strokeWeight: 6//线宽
        });
        map.setFitView();
    }
    function savedata(a){
        console.log(a);
        blr.push(a);
    }
    //利用for循环遍历所有目标公交线路
    for (var j=0;j<names.length;j++) {
        lineSearch(names[j]);
        //savedata(names[j]);//为了测试
    }
    console.log('已获得的数据',blr.length);
    //document.getElementById('search').onclick = lineSearch;
    //导出数据
</script>
</body>
</html>